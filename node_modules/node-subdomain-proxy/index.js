var url=require('url')
var request=require('request')
var util=require('util')
var express=require('express')
var request=require('request')
var fs=require('fs')

module.exports.create=function(options){
	// var app=express();
	// app.use('/',function(req,res){
	return function(req,res,next){
		if(req.headers.host==options.host){
			next();
			return;
		}
		req.url=req.protocol + '://' + req.headers.host +  req.url
		var url=module.exports.resolveUrl(req.url,options.host)
		console.log('url to request:',url)
		// console.log(url.match('://script.'))
		if(url.match('://script/')){
			console.log(0)
			console.log(__dirname)
			res.set('content-type','text/javascript')
			res.write('proxy_host="' + options.host + '";' + fs.readFileSync(__dirname+'\\shared.js').toString() + ';' 
						+fs.readFileSync(__dirname+'\\script.js').toString())
			res.end();
			return;
		}
		console.log('@',url)
		request({
			url:url,
			encoding:null,
			headers:{
				accept:req.headers.accept,
				'user-agent':req.headers['user-agent'],
				'cookie':req.headers.cookie,
				'abc':'def'
			}
		},function(err,obj,body){
			console.log('((((((((((')
			if(err){
				// res.sendStatus('500');
				res.end()
				return;
			}
			cookies=module.exports.CookiesChangeDomain(obj.headers['set-cookie'],req.headers.host,options.host)
			// res.sendStatus(obj.statusCode)
			res.set({
				'set-cookie':cookies,
				'x-xorwarded-for:':req.ip,
				'content-type':obj.headers['content-type'] || '',
			})
			if((obj.headers['content-type'] || '').match(/javascript|html/i)){
				body=body.toString('utf8')
				body=body.replace(/top!=self/g,'top==self')
				body=body.replace(/top != self/g,'top==self')
				body=body.replace(/top == self/g,'top!=self')
				body=body.replace(/top != self/g,'top!=self')

				if(obj.headers['content-type'].match(/html/i)){
					//Add out script
					body=body.replace(/(<head[^>]*?>)/,'$1<script src=' + req.protocol + '://script.' + options.host + '/' + '></script>')
					body=body.replace(/(src="?)\/\//g, '$1' + req.protocol + ':\/\/')
					body=body.replace(/(<script src="?)(.*?)("?.*?>)/g, function(a,r1,r2,r3){
						if(r2.match(/^https|http|\/\//)){
							return r1+ module.exports.createUrl(r2,options.host) +r3;
						}
						return a
					})
				}

				res.write(body)
			}
			else{
				res.write(body)
			}
			res.end();
		})
	}
	// })
	// app.listen(options.port || 80,options.ip)
}

var createUrl=module.exports.createUrl=require('./shared.js').createUrl
var resolveUrl=module.exports.resolveUrl=require('./shared.js').resolveUrl


module.exports.CookiesChangeDomain=function(cookies,newhost,host){
	if(!newhost || !host) throw new Error('CookiesChangeDomain must have newhost and host');
	if(!cookies) return ['']
	if (!cookies.length) cookies=['']
	console.log('!!',cookies,newhost,host)
	cookies=cookies.map(function(v){
		return v.replace(/(domain=)(.*?)(;|$)/,'$1' +  module.exports.createUrl(newhost,host) +'$3')
	})
	console.log('@@',cookies)
	return cookies
}