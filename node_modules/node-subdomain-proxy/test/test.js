var assert=require('chai').assert;
var request=require('request');
var async=require('async');
var subdomain_proxy=require('../index.js');

var host='rg.gy';


describe('node-subdomain.proxy',function(){

	it('createUrl',function(){
		assert.equal(
		subdomain_proxy.createUrl('http://www.this-page-intentionally-left-blank.org',host),'http://www-this--page--intentionally--left--blank-org.' + host  + '/'
		)
		assert.equal(
		subdomain_proxy.createUrl('http://www.this-page-intentionally-left-blank.org/',host),'http://www-this--page--intentionally--left--blank-org.' + host  + '/'
		)
		assert.equal(
		subdomain_proxy.createUrl('http://www.this-page-intentionally-left-blank.org/?a=b',host),'http://www-this--page--intentionally--left--blank-org.' + host + '/?a=b'
		)
		assert.equal(
		subdomain_proxy.createUrl('http://www.this-page-intentionally-left-blank.org/?a=b.c',host),'http://www-this--page--intentionally--left--blank-org.' + host + '/?a=b.c'
		)
		assert.notEqual(subdomain_proxy.createUrl('htp://www.this-page-intentionally-left-blank.org/?a=b.c'))
	})	
	it('resolveUrl',function(){
		
		assert.equal(
		subdomain_proxy.resolveUrl('https://www-this--page--intentionally--left--blank-org.' + host + '/',host),'https://www.this-page-intentionally-left-blank.org/'
		)
		assert.equal(
		subdomain_proxy.resolveUrl('https://www-this--page--intentionally--left--blank-org.' + host  + '/',host),'https://www.this-page-intentionally-left-blank.org/'
		)
		assert.equal(
		subdomain_proxy.resolveUrl('https://www-this--page--intentionally--left--blank-org.' + host + '/?a=b',host),'https://www.this-page-intentionally-left-blank.org/?a=b'
		)
		assert.equal(
		subdomain_proxy.resolveUrl('https://www-this--page--intentionally--left--blank-org.' + host + '/?a=b.c',host),'https://www.this-page-intentionally-left-blank.org/?a=b.c'
		)
		assert.notEqual(subdomain_proxy.resolveUrl('htp://www.this-page-intentionally-left-blank.org/?a=b.c'))
	})	

	it('test proxing many sites',function(done){
		// subdomain_proxy.create({
		// 	host:host
		// })

		var sites=[
			'http://www.inn.co.il',
			'http://www.google.com'
		]
		this.timeout(5000);

		async.each(sites,function(site,next){
			// console.log(subdomain_proxy.createUrl(site,host))
			request({
				url:site
			},function(err,obj,body){
				request({
					url:subdomain_proxy.createUrl(site,host)
				},function(err,obj,_body){
					assert.notOk(err);
					assert.ok(Math.abs(body.length-_body.length)<body.length/10)
					next();
				})
			})
		},function(){
			done();
		})
	})

	it('test proxing many sites(https)',function(done){
		// subdomain_proxy.create({
		// 	host:host
		// })

		var sites=[
			'https://www.google.com',
			'https://remarketing.io'
		]
		this.timeout(5000);

		async.each(sites,function(site,next){
			// console.log(subdomain_proxy.createUrl(site,host))
			request({
				url:site
			},function(err,obj,body){
				request({
					url:subdomain_proxy.createUrl(site,host)
				},function(err,obj,_body){
					assert.notOk(err);
					assert.ok(Math.abs(body.length-_body.length)<body.length/10)
					next();
				})
			})
		},function(){
			done();
		})
	})
	it('CookiesChangeDomain',function(){
		var test,result
		test =['PREF=ID=1111111111111111:FF=0:TM=1436970005:LM=1436970005:V=1:S=Mz0k3LtdZYo9620S; expires=Fri, 14-Jul-2017 14:20:05 GMT; path=/; domain=.google.co.il;abc','PREF=ID=1111111111111111:FF=0:TM=1436970005:LM=1436970005:V=1:S=Mz0k3LtdZYo9620S; expires=Fri, 14-Jul-2017 14:20:05 GMT; path=/; domain=.google.co.il;abc']
		result=subdomain_proxy.CookiesChangeDomain(test,'www-google-com.rg.gy','rg.gy')
		assert.notOk(result[0].match(/google\.com/))
		assert.ok(result[0].match('www-google-com.rg.gy'))

		test=['']
		subdomain_proxy.CookiesChangeDomain(test,'asd','asd')
		test=null
		subdomain_proxy.CookiesChangeDomain(test,'asda','asdsad')
	})
})